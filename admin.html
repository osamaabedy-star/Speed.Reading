<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المحتوى والمستخدمين - القراءة السريعة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #2b2d42;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Cairo', Tahoma, sans-serif; }

        body { background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo { display: flex; align-items: center; gap: 15px; color: var(--primary); }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 25px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .tab-btn i { font-size: 1rem; }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .main-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }

        .card-title { font-size: 1.3rem; margin-bottom: 20px; color: var(--secondary); border-bottom: 2px solid var(--bg); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        input, textarea, select {
            width: 100%; padding: 12px 15px; border: 2px solid #edf2f7; border-radius: 12px; font-size: 1rem; transition: 0.3s;
        }

        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        .btn { padding: 12px 25px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }
        .btn-secondary { background: #f1f5f9; color: var(--text); }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* أنماط الأسئلة (كما كانت) */
        .question-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            position: relative;
            border-right: 4px solid var(--primary);
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        .question-type {
            width: 200px;
        }
        .remove-question {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
        }
        .option-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .option-input {
            flex: 1;
        }
        .dynamic-fields {
            margin-top: 10px;
        }
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
        }
        .item-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .item-input {
            flex: 1;
        }
        .remove-item {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
        }
        .add-item {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 5px;
        }
        .correct-order {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }
        .order-select {
            width: 100%;
            padding: 8px;
        }

        /* أنماط جدول المستخدمين */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .users-table th {
            background: var(--primary);
            color: white;
            padding: 12px 8px;
            font-size: 0.9rem;
        }
        .users-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            font-size: 0.85rem;
        }
        .users-table tr:last-child td {
            border-bottom: none;
        }
        .badge {
            padding: 4px 10px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .badge-success {
            background: var(--success);
            color: white;
        }
        .badge-warning {
            background: #f59e0b;
            color: white;
        }
        .action-btn {
            background: transparent;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 0 3px;
            transition: 0.2s;
        }
        .action-btn.approve {
            color: var(--success);
        }
        .action-btn.reject {
            color: var(--danger);
        }
        .action-btn.delete {
            color: var(--danger);
        }
        .action-btn:hover {
            transform: scale(1.1);
        }
        .refresh-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 8px 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo">
            <i class="fas fa-user-shield fa-2x"></i>
            <div>
                <h1>لوحة التحكم</h1>
                <p style="font-size: 0.8rem; color: #64748b;">إدارة المحتوى والمستخدمين</p>
            </div>
        </div>
        <div class="actions">
            <button class="btn btn-primary" onclick="location.href='index.html'"><i class="fas fa-home"></i> المتجر</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <i class="fas fa-book-open" style="color: var(--primary)"></i>
            <div><h4 id="count-lessons">0</h4><p>نصوص</p></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-question-circle" style="color: var(--success)"></i>
            <div><h4 id="count-questions">0</h4><p>أسئلة</p></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-users" style="color: var(--primary)"></i>
            <div><h4 id="count-users">0</h4><p>مستخدمين</p></div>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-check" style="color: var(--success)"></i>
            <div><h4 id="count-approved">0</h4><p>مفعل</p></div>
        </div>
    </div>

    <!-- أزرار التبويب -->
    <div class="tabs">
        <button class="tab-btn active" id="tabLessonsBtn"><i class="fas fa-edit"></i> إدارة النصوص</button>
        <button class="tab-btn" id="tabUsersBtn"><i class="fas fa-users"></i> إدارة المستخدمين</button>
    </div>

    <!-- تبويب إدارة النصوص -->
    <div id="tabLessons" class="tab-content active">
        <div class="main-grid">
            <div class="card">
                <h3 class="card-title"><i class="fas fa-pen"></i> إضافة / تعديل نص</h3>
                <form id="lessonForm">
                    <div class="form-group">
                        <label>عنوان النص</label>
                        <input type="text" id="lessonTitle" required placeholder="أدخل العنوان...">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>الصف</label>
                            <select id="lessonGrade">
                                <option value="الأول الابتدائي">الأول الابتدائي</option>
                                <option value="الثاني الابتدائي">الثاني الابتدائي</option>
                                <option value="الثالث الابتدائي">الثالث الابتدائي</option>
                                <option value="الرابع الابتدائي">الرابع الابتدائي</option>
                                <option value="الخامس الابتدائي">الخامس الابتدائي</option>
                                <option value="السادس الابتدائي">السادس الابتدائي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الفصل</label>
                            <select id="lessonSemester">
                                <option value="1">الأول</option>
                                <option value="2">الثاني</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>محتوى النص</label>
                        <textarea id="lessonContent" rows="6" required placeholder="الصق النص هنا..."></textarea>
                    </div>

                    <div id="questionsContainer">
                        <label style="margin-top: 20px;">الأسئلة</label>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" id="addMcqBtn">
                            <i class="fas fa-plus-circle"></i> اختيار من متعدد
                        </button>
                        <button type="button" class="btn btn-secondary" id="addTrueFalseBtn">
                            <i class="fas fa-plus-circle"></i> صح/خطأ
                        </button>
                        <button type="button" class="btn btn-secondary" id="addOrderBtn">
                            <i class="fas fa-plus-circle"></i> ترتيب الأحداث
                        </button>
                        <button type="button" class="btn btn-secondary" id="addMissingLetterBtn">
                            <i class="fas fa-plus-circle"></i> حرف ناقص
                        </button>
                        <button type="button" class="btn btn-secondary" id="addSyllableOrderBtn">
                            <i class="fas fa-plus-circle"></i> ترتيب المقاطع
                        </button>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary" style="flex: 2;">حفظ التغييرات</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()" style="flex: 1;">إلغاء</button>
                    </div>
                </form>
                <div class="password-change" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="changeAdminPassword()"><i class="fas fa-key"></i> تغيير كلمة مرور الإدارة</button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-list-ul"></i> النصوص الحالية</h3>
                <div id="lessonsList"></div>
            </div>
        </div>
    </div>

    <!-- تبويب إدارة المستخدمين -->
    <div id="tabUsers" class="tab-content">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 class="card-title" style="margin-bottom: 0;"><i class="fas fa-users"></i> قائمة المستخدمين</h3>
                <button class="refresh-btn" id="refreshUsersBtn"><i class="fas fa-sync-alt"></i> تحديث</button>
            </div>
            <div style="overflow-x: auto;">
                <table class="users-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>اسم المستخدم</th>
                            <th>الاسم الكامل</th>
                            <th>رقم الجوال</th>
                            <th>رقم الحساب</th>
                            <th>الصف</th>
                            <th>الفصل</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="8" style="text-align:center;">جاري تحميل المستخدمين...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="database.js"></script>
<script>
    // ========== التحقق من صلاحية المسؤول ==========
    const STORAGE_KEY = 'reading_app_lessons';
    const ADMIN_AUTH_KEY = 'admin_auth';
    const DEFAULT_PASSWORD = 'admin';
    let editingId = null;

    async function hashString(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function checkAuth() {
        const defaultHash = await hashString(DEFAULT_PASSWORD);
        const customHash = localStorage.getItem('admin_custom_hash');
        const storedHash = customHash || defaultHash;
        
        let authHash = sessionStorage.getItem(ADMIN_AUTH_KEY);
        if (authHash === storedHash) return true;

        const pass = prompt("كلمة مرور الإدارة:");
        if (pass) {
            const inputHash = await hashString(pass);
            if (inputHash === storedHash) {
                sessionStorage.setItem(ADMIN_AUTH_KEY, inputHash);
                return true;
            } else {
                alert("كلمة مرور خاطئة!");
                window.location.href = 'index.html';
                return false;
            }
        } else {
            window.location.href = 'index.html';
            return false;
        }
    }

    window.changeAdminPassword = async function() {
        const newPass = prompt("أدخل كلمة المرور الجديدة:");
        if (!newPass) return;
        const confirmPass = prompt("تأكيد كلمة المرور الجديدة:");
        if (newPass !== confirmPass) {
            alert("كلمة المرور غير متطابقة!");
            return;
        }
        const newHash = await hashString(newPass);
        localStorage.setItem('admin_custom_hash', newHash);
        alert("تم تغيير كلمة المرور. سيتم استخدامها من الآن.");
        sessionStorage.setItem(ADMIN_AUTH_KEY, newHash);
    };

    (async function() {
        const authorized = await checkAuth();
        if (authorized) {
            init();
        }
    })();

    // ========== دوال التهيئة ==========
    function init() {
        renderLessons();
        renderUsers();
        document.getElementById('lessonForm').addEventListener('submit', saveLesson);
        document.getElementById('addMcqBtn').addEventListener('click', () => addQuestionField('mcq'));
        document.getElementById('addTrueFalseBtn').addEventListener('click', () => addQuestionField('truefalse'));
        document.getElementById('addOrderBtn').addEventListener('click', () => addQuestionField('order'));
        document.getElementById('addMissingLetterBtn').addEventListener('click', () => addQuestionField('missing_letter'));
        document.getElementById('addSyllableOrderBtn').addEventListener('click', () => addQuestionField('syllable_order'));

        // التبديل بين التبويبات
        document.getElementById('tabLessonsBtn').addEventListener('click', () => {
            document.getElementById('tabLessonsBtn').classList.add('active');
            document.getElementById('tabUsersBtn').classList.remove('active');
            document.getElementById('tabLessons').classList.add('active');
            document.getElementById('tabUsers').classList.remove('active');
        });
        document.getElementById('tabUsersBtn').addEventListener('click', () => {
            document.getElementById('tabUsersBtn').classList.add('active');
            document.getElementById('tabLessonsBtn').classList.remove('active');
            document.getElementById('tabUsers').classList.add('active');
            document.getElementById('tabLessons').classList.remove('active');
            renderUsers(); // تحديث القائمة عند الدخول
        });

        document.getElementById('refreshUsersBtn').addEventListener('click', renderUsers);
    }

    // ========== دوال النصوص (كما كانت مع تحسينات بسيطة) ==========
    function getLessons() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }

    function renderLessons() {
        const lessons = getLessons();
        const list = document.getElementById('lessonsList');
        const countL = document.getElementById('count-lessons');
        const countQ = document.getElementById('count-questions');
        
        countL.innerText = lessons.length;
        let qTotal = 0;

        list.innerHTML = lessons.map(l => {
            qTotal += (l.questions?.length || 0);
            return `
                <div class="lesson-card" data-id="${l.id}">
                    <div>
                        <strong>${escapeHtml(l.title)}</strong><br>
                        <small style="color:#666">${escapeHtml(l.grade)} - ${l.questions?.length || 0} سؤال</small>
                    </div>
                    <div class="actions">
                        <button class="btn-icon edit-btn" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon delete-btn" title="حذف"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('') || '<p style="text-align:center; color:#999;">لا يوجد محتوى مضاف.</p>';

        countQ.innerText = qTotal;

        document.querySelectorAll('.lesson-card').forEach(card => {
            const id = card.dataset.id;
            card.querySelector('.edit-btn').addEventListener('click', () => editLesson(id));
            card.querySelector('.delete-btn').addEventListener('click', () => deleteLesson(id));
        });
    }

    // دوال الأسئلة (كما هي من النسخة السابقة مع بعض التحسينات)
    function addQuestionField(type = 'mcq', data = null) {
        const container = document.getElementById('questionsContainer');
        const div = document.createElement('div');
        div.className = 'question-item';
        
        let innerHtml = `
            <div class="question-header">
                <select class="question-type" onchange="changeQuestionType(this)">
                    <option value="mcq" ${(type === 'mcq') ? 'selected' : ''}>اختيار من متعدد</option>
                    <option value="truefalse" ${(type === 'truefalse') ? 'selected' : ''}>صح/خطأ</option>
                    <option value="order" ${(type === 'order') ? 'selected' : ''}>ترتيب الأحداث</option>
                    <option value="missing_letter" ${(type === 'missing_letter') ? 'selected' : ''}>حرف ناقص</option>
                    <option value="syllable_order" ${(type === 'syllable_order') ? 'selected' : ''}>ترتيب المقاطع</option>
                </select>
                <button type="button" class="remove-question" title="حذف السؤال"><i class="fas fa-times"></i></button>
            </div>
            <input type="text" class="q-text" placeholder="نص السؤال" value="${escapeHtml(data?.text || '')}" style="width:100%; margin-bottom:10px;">
            <div class="dynamic-fields" id="dynamic-${Date.now()}-${Math.random()}"></div>
            <input type="hidden" class="q-type" value="${type}">
        `;
        div.innerHTML = innerHtml;
        const dynamicDiv = div.querySelector('.dynamic-fields');
        fillDynamicFields(dynamicDiv, type, data);
        
        div.querySelector('.remove-question').addEventListener('click', () => div.remove());
        div.querySelector('.question-type').addEventListener('change', function(e) {
            changeQuestionType(e.target);
        });
        container.appendChild(div);
    }

    function fillDynamicFields(container, type, data) {
        let html = '';
        if (type === 'mcq') {
            html = '<div class="options-container">';
            for (let i = 0; i < 4; i++) {
                html += `<input type="text" class="option-input" placeholder="خيار ${i+1}" value="${escapeHtml(data?.options?.[i] || '')}">`;
            }
            html += '</div>';
            html += `<select class="correct-select">
                        <option value="">اختر الإجابة الصحيحة</option>
                        ${[0,1,2,3].map(i => `<option value="${i}" ${data?.correct == i ? 'selected' : ''}>خيار ${i+1}</option>`).join('')}
                    </select>`;
        } else if (type === 'truefalse') {
            html = '<div class="options-container">';
            html += `<input type="text" class="option-input" placeholder="الإجابة الصحيحة (مثال: صح)" value="${escapeHtml(data?.options?.[0] || 'صح')}">`;
            html += `<input type="text" class="option-input" placeholder="الإجابة الخاطئة (مثال: خطأ)" value="${escapeHtml(data?.options?.[1] || 'خطأ')}">`;
            html += '</div>';
            html += `<select class="correct-select">
                        <option value="">اختر الإجابة الصحيحة</option>
                        <option value="0" ${data?.correct == 0 ? 'selected' : ''}>الخيار الأول (صح)</option>
                        <option value="1" ${data?.correct == 1 ? 'selected' : ''}>الخيار الثاني (خطأ)</option>
                    </select>`;
        } else if (type === 'order') {
            let items = data?.items || ['', '', ''];
            let correctOrder = data?.correctOrder || [0,1,2];
            html = '<div class="items-list" id="order-items">';
            items.forEach((item, idx) => {
                html += `<div class="item-row">
                            <input type="text" class="item-input" placeholder="حدث ${idx+1}" value="${escapeHtml(item)}">
                            <button type="button" class="remove-item" onclick="this.closest('.item-row').remove()"><i class="fas fa-times"></i></button>
                        </div>`;
            });
            html += '</div>';
            html += `<button type="button" class="add-item" onclick="addOrderItem(this)">+ إضافة حدث</button>`;
            html += `<div class="correct-order"><label>الترتيب الصحيح (أرقام الأحداث حسب الأولوية):</label>`;
            html += `<div id="order-selects"></div>`;
            html += `</div>`;
            setTimeout(() => {
                const selectsDiv = container.parentElement.querySelector('#order-selects');
                if (selectsDiv) updateOrderSelects(container.parentElement);
            }, 10);
        } else if (type === 'missing_letter') {
            html = `<div class="form-group"><label>الكلمة مع فراغ (مثال: كـتاب)</label>
                    <input type="text" class="word-input" placeholder="الكلمة مع فراغ" value="${escapeHtml(data?.word || '')}"></div>
                    <div class="form-group"><label>مكان الحرف الناقص (0-based index)</label>
                    <input type="number" class="missing-index" min="0" value="${data?.missingIndex || 0}"></div>
                    <div class="options-container" id="missing-options">
                        <label>خيارات الحروف:</label>`;
            let options = data?.options || ['ا', 'ب', 'ت'];
            options.forEach((opt, i) => {
                html += `<input type="text" class="option-input" placeholder="حرف ${i+1}" value="${escapeHtml(opt)}">`;
            });
            html += `<button type="button" class="add-item" onclick="addMissingOption(this)">+ إضافة حرف</button>`;
            html += `</div>`;
            html += `<select class="correct-select">
                        <option value="">اختر الحرف الصحيح (رقم الخيار)</option>
                        ${options.map((opt, i) => `<option value="${i}" ${data?.correct == i ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>`;
        } else if (type === 'syllable_order') {
            let items = data?.items || ['كَ', 'تِ', 'بَ'];
            html = '<div class="items-list" id="syllable-items">';
            items.forEach((item, idx) => {
                html += `<div class="item-row">
                            <input type="text" class="item-input" placeholder="مقطع ${idx+1}" value="${escapeHtml(item)}">
                            <button type="button" class="remove-item" onclick="this.closest('.item-row').remove()"><i class="fas fa-times"></i></button>
                        </div>`;
            });
            html += '</div>';
            html += `<button type="button" class="add-item" onclick="addSyllableItem(this)">+ إضافة مقطع</button>`;
            html += `<div class="correct-order"><label>الترتيب الصحيح (أرقام المقاطع حسب التسلسل):</label>`;
            html += `<div id="syllable-selects"></div>`;
            html += `</div>`;
            setTimeout(() => {
                const selectsDiv = container.parentElement.querySelector('#syllable-selects');
                if (selectsDiv) updateSyllableSelects(container.parentElement);
            }, 10);
        }
        container.innerHTML = html;
    }

    window.addOrderItem = function(btn) {
        const container = btn.closest('.dynamic-fields');
        const itemsList = container.querySelector('#order-items');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.innerHTML = `<input type="text" class="item-input" placeholder="حدث جديد" value=""><button type="button" class="remove-item" onclick="this.closest('.item-row').remove()"><i class="fas fa-times"></i></button>`;
        itemsList.appendChild(newRow);
        updateOrderSelects(container.parentElement);
    };

    function updateOrderSelects(questionDiv) {
        const items = questionDiv.querySelectorAll('#order-items .item-input');
        const selectsDiv = questionDiv.querySelector('#order-selects');
        if (!selectsDiv) return;
        let html = '';
        for (let i = 0; i < items.length; i++) {
            html += `<select class="order-select" data-order="${i}">`;
            for (let j = 0; j < items.length; j++) {
                html += `<option value="${j}">الحدث ${j+1}</option>`;
            }
            html += '</select><br>';
        }
        selectsDiv.innerHTML = html;
        const savedOrder = questionDiv.dataset.savedOrder ? JSON.parse(questionDiv.dataset.savedOrder) : null;
        if (savedOrder) {
            const selects = selectsDiv.querySelectorAll('select');
            selects.forEach((sel, idx) => {
                sel.value = savedOrder[idx];
            });
        }
    }

    window.addSyllableItem = function(btn) {
        const container = btn.closest('.dynamic-fields');
        const itemsList = container.querySelector('#syllable-items');
        const newRow = document.createElement('div');
        newRow.className = 'item-row';
        newRow.innerHTML = `<input type="text" class="item-input" placeholder="مقطع جديد" value=""><button type="button" class="remove-item" onclick="this.closest('.item-row').remove()"><i class="fas fa-times"></i></button>`;
        itemsList.appendChild(newRow);
        updateSyllableSelects(container.parentElement);
    };

    function updateSyllableSelects(questionDiv) {
        const items = questionDiv.querySelectorAll('#syllable-items .item-input');
        const selectsDiv = questionDiv.querySelector('#syllable-selects');
        if (!selectsDiv) return;
        let html = '';
        for (let i = 0; i < items.length; i++) {
            html += `<select class="order-select" data-order="${i}">`;
            for (let j = 0; j < items.length; j++) {
                html += `<option value="${j}">المقطع ${j+1}</option>`;
            }
            html += '</select><br>';
        }
        selectsDiv.innerHTML = html;
        const savedOrder = questionDiv.dataset.savedOrder ? JSON.parse(questionDiv.dataset.savedOrder) : null;
        if (savedOrder) {
            const selects = selectsDiv.querySelectorAll('select');
            selects.forEach((sel, idx) => {
                sel.value = savedOrder[idx];
            });
        }
    }

    window.addMissingOption = function(btn) {
        const container = btn.closest('#missing-options');
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.className = 'option-input';
        newInput.placeholder = 'حرف جديد';
        container.insertBefore(newInput, btn);
    };

    window.changeQuestionType = function(selectEl) {
        const questionItem = selectEl.closest('.question-item');
        const newType = selectEl.value;
        const text = questionItem.querySelector('.q-text')?.value || '';
        const dynamicDiv = questionItem.querySelector('.dynamic-fields');
        fillDynamicFields(dynamicDiv, newType, null);
        questionItem.querySelector('.q-type').value = newType;
    };

    function saveLesson(e) {
        e.preventDefault();

        const title = document.getElementById('lessonTitle').value.trim();
        const grade = document.getElementById('lessonGrade').value;
        const semester = document.getElementById('lessonSemester').value;
        const content = document.getElementById('lessonContent').value.trim();

        if (!title || !content) {
            alert('الرجاء إدخال عنوان ومحتوى النص');
            return;
        }

        const questionItems = document.querySelectorAll('.question-item');
        const questions = [];
        for (let item of questionItems) {
            const text = item.querySelector('.q-text')?.value.trim();
            const type = item.querySelector('.question-type')?.value;
            
            if (!text) {
                alert('يرجى إدخال نص السؤال');
                return;
            }

            let questionData = { text, type };

            if (type === 'mcq' || type === 'truefalse') {
                const options = Array.from(item.querySelectorAll('.option-input')).map(i => i.value.trim());
                const correct = item.querySelector('.correct-select')?.value;
                if (options.some(o => o === '')) {
                    alert('يرجى ملء جميع الخيارات');
                    return;
                }
                if (correct === '') {
                    alert('يرجى اختيار الإجابة الصحيحة');
                    return;
                }
                questionData.options = options;
                questionData.correct = parseInt(correct);
            } else if (type === 'order') {
                const items = Array.from(item.querySelectorAll('#order-items .item-input')).map(i => i.value.trim());
                if (items.some(i => i === '')) {
                    alert('يرجى ملء جميع الأحداث');
                    return;
                }
                const orderSelects = Array.from(item.querySelectorAll('#order-selects select')).map(s => parseInt(s.value));
                if (orderSelects.length !== items.length) {
                    alert('خطأ في تحديد الترتيب');
                    return;
                }
                questionData.items = items;
                questionData.correctOrder = orderSelects;
            } else if (type === 'missing_letter') {
                const word = item.querySelector('.word-input')?.value.trim();
                const missingIndex = parseInt(item.querySelector('.missing-index')?.value);
                const options = Array.from(item.querySelectorAll('#missing-options .option-input')).map(i => i.value.trim());
                const correct = item.querySelector('.correct-select')?.value;
                if (!word || isNaN(missingIndex) || options.some(o => o === '') || correct === '') {
                    alert('يرجى ملء جميع حقول الحرف الناقص');
                    return;
                }
                questionData.word = word;
                questionData.missingIndex = missingIndex;
                questionData.options = options;
                questionData.correct = parseInt(correct);
            } else if (type === 'syllable_order') {
                const items = Array.from(item.querySelectorAll('#syllable-items .item-input')).map(i => i.value.trim());
                if (items.some(i => i === '')) {
                    alert('يرجى ملء جميع المقاطع');
                    return;
                }
                const orderSelects = Array.from(item.querySelectorAll('#syllable-selects select')).map(s => parseInt(s.value));
                if (orderSelects.length !== items.length) {
                    alert('خطأ في تحديد الترتيب');
                    return;
                }
                questionData.items = items;
                questionData.correctOrder = orderSelects;
            }

            questions.push(questionData);
        }

        const lessons = getLessons();
        const newLesson = {
            id: editingId || Date.now().toString(),
            title: title,
            grade: grade,
            semester: semester,
            content: content,
            questions: questions
        };

        if (editingId) {
            const idx = lessons.findIndex(l => l.id === editingId);
            if (idx !== -1) lessons[idx] = newLesson;
        } else {
            lessons.push(newLesson);
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(lessons));
        alert('تم الحفظ بنجاح!');
        resetForm();
        renderLessons();
    }

    function editLesson(id) {
        const lesson = getLessons().find(l => l.id === id);
        if (!lesson) return;

        editingId = id;
        document.getElementById('lessonTitle').value = lesson.title;
        document.getElementById('lessonGrade').value = lesson.grade;
        document.getElementById('lessonSemester').value = lesson.semester;
        document.getElementById('lessonContent').value = lesson.content;

        document.getElementById('questionsContainer').innerHTML = '';
        if (lesson.questions) {
            lesson.questions.forEach(q => {
                addQuestionField(q.type, q);
            });
        }
        window.scrollTo(0, 0);
    }

    function deleteLesson(id) {
        if (confirm('هل أنت متأكد من حذف هذا النص؟')) {
            const lessons = getLessons().filter(l => l.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(lessons));
            renderLessons();
            if (editingId === id) resetForm();
        }
    }

    function resetForm() {
        editingId = null;
        document.getElementById('lessonForm').reset();
        document.getElementById('questionsContainer').innerHTML = '';
    }

    // ========== دوال إدارة المستخدمين ==========
    async function renderUsers() {
        try {
            const users = await getAllUsers();
            const tbody = document.getElementById('usersTableBody');
            const countUsers = document.getElementById('count-users');
            const countApproved = document.getElementById('count-approved');

            countUsers.innerText = users.length;
            const approvedCount = users.filter(u => u.approved === true).length;
            countApproved.innerText = approvedCount;

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">لا يوجد مستخدمين</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const approved = user.approved === true;
                return `
                <tr>
                    <td>${escapeHtml(user.username)}</td>
                    <td>${escapeHtml(user.fullName || '-')}</td>
                    <td dir="ltr">${escapeHtml(user.phone || '-')}</td>
                    <td dir="ltr">${escapeHtml(user.accountNumber || '-')}</td>
                    <td>${escapeHtml(user.grade || '-')}</td>
                    <td>${user.semester === '1' ? 'الأول' : 'الثاني'}</td>
                    <td>
                        <span class="badge ${approved ? 'badge-success' : 'badge-warning'}">
                            ${approved ? 'مفعل' : 'غير مفعل'}
                        </span>
                    </td>
                    <td>
                        <button class="action-btn approve" title="${approved ? 'تعطيل' : 'تفعيل'}" onclick="toggleApprove('${user.username}', ${!approved})">
                            <i class="fas ${approved ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                        </button>
                        <button class="action-btn delete" title="حذف" onclick="deleteUserHandler('${user.username}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        } catch (error) {
            console.error(error);
            document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--danger);">خطأ في تحميل المستخدمين</td></tr>';
        }
    }

    window.toggleApprove = async function(username, newStatus) {
        if (!confirm(`هل أنت متأكد من ${newStatus ? 'تفعيل' : 'تعطيل'} هذا المستخدم؟`)) return;
        try {
            await updateUserApproval(username, newStatus);
            await renderUsers();
            alert('تم تحديث حالة المستخدم');
        } catch (error) {
            alert('فشل في تحديث الحالة: ' + error);
        }
    };

    window.deleteUserHandler = async function(username) {
        if (!confirm('هل أنت متأكد من حذف هذا المستخدم نهائياً؟')) return;
        try {
            await deleteUser(username);
            await renderUsers();
            alert('تم حذف المستخدم');
        } catch (error) {
            alert('فشل في حذف المستخدم: ' + error);
        }
    };

    // دالة مساعدة للهروب من HTML
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe.replace(/[&<>"]/g, function(m) {
            if (m === '&') return '&amp;';
            if (m === '<') return '&lt;';
            if (m === '>') return '&gt;';
            if (m === '"') return '&quot;';
            return m;
        });
    }
</script>
</body>
</html>